// @/prisma/schema.prisma

generator client {
  provider               = "prisma-client-js"
  output                 = "./generated/client"
  engineType             = "client"
  runtime                = "vercel-edge"
  generatedFileExtension = "ts"
  importFileExtension    = "ts"
}

datasource db {
  provider = "postgresql"
}

// ================ AUTHENTICATION ================

enum UserRole {
  ADMIN
  STAFF
  VIEWER
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String   @map("hashed_password")
  role      UserRole
  is_active Boolean  @default(true)
  first_name String?
  last_name  String?
  image      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  api_keys ApiKey[]

  @@map("users")
}

model ApiKey {
  id           String    @id @default(uuid())
  user_id      String
  name         String
  key_hash     String // SHA-256 hash of the key (raw key never stored)
  key_prefix   String // e.g. "rf_xxxx" for display only
  last_used_at DateTime?
  created_at   DateTime  @default(now())

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([key_hash])
  @@map("api_keys")
}

// ================ TABLES ================

enum PersonType {
  student
  teacher
  staff
  visitor
}

model Person {
  id         Int           @id @default(dbgenerated("1000000 + floor(random() * 9000000)::int"))
  rfid_uuid  String        @unique
  type       PersonType
  last_name  String
  first_name String
  photo      String?
  created_at DateTime      @default(now())
  updated_at DateTime      @updatedAt

  attendance       Attendance[]
  student_payments StudentPayment[]

  @@map("persons")
}

model Attendance {
  id              Int              @id @default(autoincrement())
  person_id       Int
  action          AttendanceAction
  status          AttendanceStatus
  attendance_date DateTime         @default(now())

  person Person @relation(fields: [person_id], references: [id], onDelete: Cascade)

  @@map("attendance")
}

model Payment {
  id             Int           @id @default(autoincrement())
  amount         Float
  payment_method PaymentMethod
  payment_date   DateTime      @default(now())

  student_payments StudentPayment[]

  @@map("payments")
}

model StudentPayment {
  id         Int @id @default(autoincrement())
  student_id Int
  payment_id Int
  trimester  Int

  student Person  @relation(fields: [student_id], references: [id], onDelete: Cascade)
  payment Payment @relation(fields: [payment_id], references: [id], onDelete: Cascade)

  @@map("student_payments")
}

enum AttendanceAction {
  in
  out
}

enum AttendanceStatus {
  success
  failed
}

enum PaymentMethod {
  cash
  card
  bank_transfer
}

enum StudentLevel {
  License_1
  License_2
  License_3
  Master_1
  Master_2
}
